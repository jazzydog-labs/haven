# Caddyfile for Haven reverse proxy configuration
# Serves both frontend and backend from same domain to avoid CORS

# Development configuration
haven.local {
    # API routes
    handle /api/* {
        reverse_proxy api:8080
    }
    
    # GraphQL endpoint
    handle /graphql* {
        reverse_proxy api:8080
    }
    
    # API documentation
    handle /docs* {
        reverse_proxy api:8080
    }
    
    # Health check
    handle /health {
        reverse_proxy api:8080
    }
    
    # Frontend (when running)
    handle {
        # During development, proxy to Vite dev server
        # Change port to 3000 if using different React setup
        reverse_proxy host.docker.internal:5173 {
            # Fallback to static message if frontend not running
            fail_duration 5s
            handle_response {
                @error status 502 503 504
                handle @error {
                    respond "Frontend not running. Start with: just run-web" 503
                }
            }
        }
    }
}

# Alternative: Separate subdomains
api.haven.local {
    reverse_proxy api:8080
}

app.haven.local {
    reverse_proxy host.docker.internal:5173 {
        fail_duration 5s
        handle_response {
            @error status 502 503 504
            handle @error {
                respond "Frontend not running. Start with: just run-web" 503
            }
        }
    }
}